<div class="grid two">
  <div class="card">
    <h3>Enedis credentials</h3>
    <p class="status">Stored securely with data protection.</p>
    <form [formGroup]="credentialsForm" (ngSubmit)="saveCredentials()">
      <div>
        <label for="enedisLogin">Login</label>
        <input id="enedisLogin" type="text" formControlName="login" placeholder="Enedis login">
      </div>
      <div>
        <label for="enedisPassword">Password</label>
        <input id="enedisPassword" type="password" formControlName="password" placeholder="Enedis password">
      </div>
      <div>
        <label for="enedisMeter">Linky meter number</label>
        <input id="enedisMeter" type="text" formControlName="meterNumber" placeholder="Meter number">
      </div>

      <!-- Location section -->
      <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
        <button
          type="button"
          class="btn-secondary"
          (click)="toggleLocationMap()"
          style="margin-bottom: 1rem;"
        >
          {{ showLocationMap() ? "Hide location" : "Set meter location" }}
        </button>

        @if (showLocationMap()) {
          <app-address-map-input
            [initialAddress]="credentialsForm.get('address')?.value || ''"
            [initialLatitude]="credentialsForm.get('latitude')?.value || undefined"
            [initialLongitude]="credentialsForm.get('longitude')?.value || undefined"
            (addressSelected)="onLocationSelected($event)"
          ></app-address-map-input>
        }

        @if (selectedCoordinates().latitude && selectedCoordinates().longitude) {
          <div class="coordinates-display" style="margin-top: 1rem;">
            <p class="status positive">
              üìç {{ selectedCoordinates().address || 'Location selected' }}<br>
              <small>{{ selectedCoordinates().latitude?.toFixed(4) }}, {{ selectedCoordinates().longitude?.toFixed(4) }}</small>
            </p>
          </div>
        }
      </div>

      <button class="btn" type="submit" [disabled]="saving()" style="margin-top: 1rem;">Save</button>
    </form>

    @if (message()) {
      <p class="status" style="margin-top: 1rem;">{{ message() }}</p>
    }
  </div>

  <div class="card">
    <h3>Import consumption</h3>
    <form [formGroup]="importForm" (ngSubmit)="startImport()">
      <div>
        <label for="importFrom">From</label>
        <input id="importFrom" type="datetime-local" formControlName="from">
      </div>
      <div>
        <label for="importTo">To</label>
        <input id="importTo" type="datetime-local" formControlName="to">
      </div>
      <button class="btn" type="submit" [disabled]="importing()">Start import</button>
    </form>

    @if (job()) {
      <div style="margin-top: 12px;">
        <div class="status">Job: {{ job()!.id }}</div>
        <div class="status" [class.positive]="job()!.status === 'Completed'" [class.negative]="job()!.status === 'Failed'">
          Status: {{ job()!.status }} ‚Ä¢ Imported: {{ job()!.importedCount }}
        </div>
        @if (job()!.errorMessage) {
          <div class="status negative">{{ job()!.errorMessage }}</div>
        }
      </div>
    }
  </div>
</div>
