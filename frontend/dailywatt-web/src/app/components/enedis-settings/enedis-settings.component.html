<div class="grid two">
  <div class="card">
    <h3>Enedis credentials</h3>
    <p class="status">Stored securely with data protection.</p>
    
    @if (loading()) {
      <div style="padding: 2rem; text-align: center; color: #64748b;">
        Loading credentials...
      </div>
    } @else {
      <form [formGroup]="credentialsForm" (ngSubmit)="saveCredentials()">
      <div>
        <label for="enedisLogin">Login</label>
        <input id="enedisLogin" type="text" formControlName="login" placeholder="Enedis login">
      </div>
      <div>
        <label for="enedisPassword">Password</label>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
          <input 
            id="enedisPassword" 
            [type]="showPassword() ? 'text' : 'password'" 
            formControlName="password" 
            placeholder="Enedis password"
            style="flex: 1;">
          <button
            type="button"
            (click)="togglePasswordVisibility()"
            class="btn-icon"
            title="Toggle password visibility"
            style="padding: 0.5rem 0.75rem; background: #f1f5f9; border: 1px solid #cbd5e1; border-radius: 0.375rem; cursor: pointer; font-size: 1rem;"
          >
            {{ showPassword() ? 'ğŸ‘ï¸' : 'ğŸ‘ï¸â€ğŸ—¨ï¸' }}
          </button>
        </div>
      </div>
      <div>
        <label for="enedisMeter">Linky meter number</label>
        <input id="enedisMeter" type="text" formControlName="meterNumber" placeholder="Meter number">
      </div>

      <!-- Location section -->
      <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
        <h4 style="margin-top: 0;">Meter Location</h4>
        <app-address-map-input
          [initialAddress]="loadedAddress() || credentialsForm.get('address')?.value || ''"
          [initialLatitude]="credentialsForm.get('latitude')?.value || undefined"
          [initialLongitude]="credentialsForm.get('longitude')?.value || undefined"
          (addressSelected)="onLocationSelected($event)"
          [isInitialLoad]="isInitialLoad"
          [isLoadedAddress]="loadedAddress() !== ''"
        ></app-address-map-input>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
          <div>
            <label for="enedisLatitude">Latitude</label>
            <input id="enedisLatitude" type="number" formControlName="latitude" disabled placeholder="Latitude" step="0.0001">
          </div>
          <div>
            <label for="enedisLongitude">Longitude</label>
            <input id="enedisLongitude" type="number" formControlName="longitude" disabled placeholder="Longitude" step="0.0001">
          </div>
        </div>
      </div>

      <button class="btn" type="submit" [disabled]="saving()" style="margin-top: 1rem;">Save</button>
    </form>
    }

    @if (message()) {
      <p class="status" style="margin-top: 1rem;">{{ message() }}</p>
    }
  </div>

  <div class="card">
    <h3>Import consumption</h3>
    <form [formGroup]="importForm" (ngSubmit)="startImport()">
      <div>
        <label for="importFrom">From</label>
        <input id="importFrom" type="datetime-local" formControlName="from">
      </div>
      <div>
        <label for="importTo">To</label>
        <input id="importTo" type="datetime-local" formControlName="to">
      </div>
      <button class="btn" type="submit" [disabled]="importing()">Start import</button>
    </form>

    @if (job()) {
      <div style="margin-top: 12px;">
        <div class="status">Job: {{ job()!.id }}</div>
        <div class="status" [class.positive]="job()!.status === 'Completed'" [class.negative]="job()!.status === 'Failed'">
          Status: {{ job()!.status }} â€¢ Imported: {{ job()!.importedCount }}
        </div>
        @if (job()!.errorMessage) {
          <div class="status negative">{{ job()!.errorMessage }}</div>
        }
      </div>
    }
  </div>
</div>
