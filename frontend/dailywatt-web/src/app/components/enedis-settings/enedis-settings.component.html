<div class="enedis-settings">
  <div class="card">
    <h3>Linky Meters</h3>
    <p class="subtitle">Manage your electricity meters and import consumption data from Excel.</p>

    @if (meters().length === 0) {
      <div class="empty-state">
        <div class="empty-icon">üîå</div>
        <div class="empty-text">No meters configured yet</div>
        <p class="empty-subtext">Add your first Linky meter to get started</p>
      </div>
    }

    @if (meters().length > 0) {
      <div class="meters-list">
        @for (meter of meters(); track meter.id) {
          <div class="meter-card">
            <div class="meter-header">
              <div class="meter-info">
                <h4 class="meter-title">
                  {{ meter.label || meter.prm }}
                  @if (meter.isFavorite) {
                    <span class="badge-favorite">‚≠ê Default</span>
                  }
                </h4>
                <p class="meter-meta">
                  PRM: <code>{{ meter.prm }}</code>
                  @if (meter.city) {
                    ¬∑ {{ meter.city }}
                  }
                </p>
              </div>
              <div class="meter-actions">
                @if (!meter.isFavorite) {
                  <button mat-stroked-button (click)="setFavorite(meter)" title="Set as default">‚òÖ Default</button>
                }
                <button mat-stroked-button (click)="editMeter(meter)" title="Edit meter">Edit</button>
                <button mat-raised-button color="warn" (click)="deleteMeter(meter)" title="Delete meter">Delete</button>
              </div>
            </div>

            <!-- Excel import section -->
            <div class="import-section">
              <div class="import-form">
                <input 
                  type="file" 
                  accept=".xlsx,.xls"
                  (change)="onImportFileSelected($event)"
                  #fileInput
                  class="file-input">
                <button 
                  mat-raised-button
                  type="button" 
                  (click)="fileInput.click()"
                  [disabled]="importInProgress()">
                  üìÅ Choose file
                </button>
                <span class="file-name">{{ selectedImportFile() ? selectedImportFile()?.name : 'No file selected' }}</span>
                <button 
                  mat-raised-button
                  color="primary"
                  type="button" 
                  (click)="startImportForMeter(meter)" 
                  [disabled]="!selectedImportFile() || importInProgress()">
                  {{ importInProgress() ? 'Importing...' : 'Import Excel' }}
                </button>
              </div>
            </div>
          </div>
        }
      </div>
    }

    @if (!isAddingMeter() && !editingMeter()) {
      <button mat-raised-button color="primary" (click)="startAddMeter()" style="margin-top: 16px;">+ Add Meter</button>
    }

    <!-- Meter form (add/edit) -->
    @if (isAddingMeter() || editingMeter()) {
      <form [formGroup]="meterForm" (ngSubmit)="saveMeter()" class="meter-form">
        <h4>{{ editingMeter() ? 'Edit Meter' : 'Add New Meter' }}</h4>
        
        <div class="form-row">
          <div class="form-group">
            <mat-form-field>
              <mat-label>PRM (meter number) *</mat-label>
              <input 
                matInput
                type="text" 
                formControlName="prm" 
                placeholder="14 digit PRM"
                [disabled]="!!editingMeter()">
            </mat-form-field>
          </div>

          <div class="form-group">
            <mat-form-field>
              <mat-label>Label (optional)</mat-label>
              <input 
                matInput
                type="text" 
                formControlName="label" 
                placeholder="e.g., Main house, Garage">
            </mat-form-field>
          </div>
        </div>

        <div class="form-section">
          <h5>Meter Location</h5>
          <app-address-map-input
            [initialAddress]="loadedCity()"
            [initialLatitude]="meterForm.get('latitude')?.value || undefined"
            [initialLongitude]="meterForm.get('longitude')?.value || undefined"
            (addressSelected)="onLocationSelected($event)"
            [isInitialLoad]="isInitialLoad"
            [isLoadedAddress]="loadedCity() !== ''"
          ></app-address-map-input>

          <div class="form-row">
            <div class="form-group">
              <mat-form-field>
                <mat-label>Latitude</mat-label>
                <input 
                  matInput
                  type="number" 
                  formControlName="latitude" 
                  disabled
                  placeholder="Latitude"
                  step="0.0001">
              </mat-form-field>
            </div>
            <div class="form-group">
              <mat-form-field>
                <mat-label>Longitude</mat-label>
                <input 
                  matInput
                  type="number" 
                  formControlName="longitude" 
                  disabled
                  placeholder="Longitude"
                  step="0.0001">
              </mat-form-field>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button mat-raised-button color="primary" type="submit">{{ editingMeter() ? 'Update' : 'Add' }}</button>
          <button mat-stroked-button type="button" (click)="cancelMeterEdit()">Cancel</button>
        </div>
      </form>
    }

    @if (message()) {
      <div class="status info" style="margin-top: 16px;">{{ message() }}</div>
    }
  </div>
</div>
