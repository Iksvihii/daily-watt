<div style="max-width: 100%; margin: 0 auto;">
  <!-- Enedis status and Dashboard form on same row -->
  <div class="top-section">
    <!-- Enedis status - small card -->
    <div class="status-card">
      @if (statusMessage()) {
        <div class="status-message">{{ statusMessage() }}</div>
      }
      @if (!status() || !status()!.configured) {
        <div class="status-content unconfigured">
          <div class="status-icon">‚öôÔ∏è</div>
          <div class="status-text">
            <p class="status-title">Enedis not configured</p>
            <p class="status-description">Add your credentials and meter to synchronize consumption data</p>
          </div>
          <a class="btn btn-secondary" routerLink="/enedis">Configure Enedis</a>
        </div>
      } @else {
        <div class="status-content configured">
          <!-- Meter selector with detailed info -->
          @if (meters().length > 0) {
            <div class="meter-selector-container">
              <label for="meterSelectStatus" class="meter-label">Selected Meter</label>
              <div class="meter-selector-row">
                <select 
                  id="meterSelectStatus" 
                  [(ngModel)]="selectedMeterId" 
                  (ngModelChange)="onMeterChange($event)"
                  name="meterStatus"
                  class="meter-select">
                  @for (meter of meters(); track meter.id) {
                    <option [value]="meter.id">
                      {{ meter.prm }}
                      @if (meter.isFavorite) { ‚≠ê }
                    </option>
                  }
                </select>
                <button 
                  class="btn btn-sync" 
                  type="button" 
                  (click)="syncNow()" 
                  [disabled]="syncing()"
                  title="Synchronize now">
                  @if (syncing()) {
                    <span class="sync-spinner">‚ü≥</span>
                  } @else {
                    <span>‚ü≥</span>
                  }
                </button>
              </div>
              @if (selectedMeter()) {
                <div class="meter-details">
                  <div class="info-item">
                    <span class="info-label">Label</span>
                    <span class="info-value">{{ selectedMeter()!.label || 'N/A' }}</span>
                  </div>
                  @if (selectedMeter()!.city) {
                    <div class="info-item">
                      <span class="info-label">City</span>
                      <span class="info-value">{{ selectedMeter()!.city }}</span>
                    </div>
                  }
                  <div class="info-item">
                    <span class="info-label">Last Sync</span>
                    <span class="info-value">{{ status()!.updatedAt | date:'short' }}</span>
                  </div>
                </div>
              }
            </div>
          }
          <button class="btn btn-primary" type="button" (click)="syncNow()" [disabled]="syncing()" style="display: none;">
            @if (syncing()) {
              <span>Synchronizing...</span>
            } @else {
              <span>Sync Now</span>
            }
          </button>
        </div>
      }
    </div>

    @if (status() && status()!.configured) {
      <!-- Dashboard form card -->
      <div class="card dashboard-form">
        <div class="dashboard-header">
          <h3>Dashboard</h3>
          <button class="btn" type="button" (click)="load()" [disabled]="loading()">Load</button>
        </div>
        <form>
          <div class="form-row">
            <div class="form-group">
              <label for="fromDate">From</label>
              <input id="fromDate" type="datetime-local" [ngModel]="from()" (ngModelChange)="from.set($event)" name="from">
            </div>
            <div class="form-group">
              <label for="toDate">To</label>
              <input id="toDate" type="datetime-local" [ngModel]="to()" (ngModelChange)="to.set($event)" name="to">
            </div>
            <div class="form-group">
              <label for="granularity">Granularity</label>
              <select id="granularity" [ngModel]="granularity()" (ngModelChange)="granularity.set($event)" name="granularity" class="custom-select">
                <option value="day">Day</option>
                <option value="month">Month</option>
                <option value="year">Year</option>
              </select>
            </div>
            <div class="checkbox-wrapper">
              <input 
                type="checkbox" 
                [ngModel]="withWeather()" 
                (ngModelChange)="withWeather.set($event)" 
                id="weather" 
                name="weather"
                class="custom-checkbox">
              <label for="weather">Show temperature</label>
            </div>
          </div>
        </form>
        @if (error()) {
          <p class="status negative">{{ error() }}</p>
        }
      </div>
    }
  </div>

  @if (status() && status()!.configured) {
    <!-- Summary cards and chart: always visible with conditional content -->
    <div class="chart-wrapper">
      @if (data() && data()!.consumption.length > 0) {
        <!-- Data available: show stats and chart -->
        <div class="grid two" style="margin-bottom: 1rem;">
          <div class="card">
            <div class="status">Total kWh</div>
            <div style="font-size:28px;font-weight:700;">{{ data()!.summary.totalKwh | number:'1.0-2' }}</div>
          </div>
          <div class="card">
            <div class="status">Average per day</div>
            <div style="font-size:28px;font-weight:700;">{{ data()!.summary.avgKwhPerDay | number:'1.0-2' }}</div>
          </div>
          <div class="card">
            <div class="status">Max day</div>
            <div style="font-size:28px;font-weight:700;">{{ data()!.summary.maxDayKwh | number:'1.0-2' }}</div>
            <div class="status">{{ data()!.summary.maxDay }}</div>
          </div>
        </div>

        <app-consumption-chart 
          [consumption]="data()!.consumption"
          [granularity]="granularity()"
          [weather]="withWeather() ? data()!.weather : undefined">
        </app-consumption-chart>
      } @else if (loading()) {
        <!-- Loading state -->
        <div class="card" style="padding: 3rem; text-align: center; color: #94a3b8;">
          <div style="display: inline-flex; align-items: center; gap: 0.75rem; flex-direction: column;">
            <div style="width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #3ad1c5; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
            <div>Loading consumption data...</div>
          </div>
        </div>
      } @else {
        <!-- No data: show empty state with suggestion -->
        <div class="card" style="padding: 3rem; text-align: center;">
          <div style="color: #94a3b8; margin-bottom: 1rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
            <p><strong>No data available</strong></p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem;">
              No consumption data found for the selected date range.
            </p>
          </div>
          <button class="btn" type="button" (click)="syncNow()" [disabled]="syncing()">
            Synchronize Now
          </button>
          <p style="font-size: 0.875rem; color: #64748b; margin-top: 1rem;">
            Sync your Linky meter to import consumption data
          </p>
        </div>
      }
    </div>
  }
</div>
