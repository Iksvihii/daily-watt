<div class="card">
  <h3>Enedis status</h3>
  @if (statusMessage()) {
    <p class="status">{{ statusMessage() }}</p>
  }
  @if (!status() || !status()!.configured) {
    <p class="status">Enedis n'est pas configurÃ©. Ajoutez vos identifiants et compteur pour synchroniser.</p>
    <a class="btn" routerLink="/enedis">Configurer Enedis</a>
  } @else {
    <div class="status">Compteur: {{ status()!.meterNumber }} â€¢ Maj: {{ status()!.updatedAt | date:'short' }}</div>
    <button class="btn" type="button" (click)="syncNow()" [disabled]="syncing()">Synchroniser maintenant</button>
  }
</div>

@if (status() && status()!.configured) {
  <div class="card">
    <h3>Dashboard</h3>
    <form class="grid two" (ngSubmit)="load()">
      <div>
        <label for="fromDate">From</label>
        <input id="fromDate" type="datetime-local" [ngModel]="from()" (ngModelChange)="from.set($event)" name="from">
      </div>
      <div>
        <label for="toDate">To</label>
        <input id="toDate" type="datetime-local" [ngModel]="to()" (ngModelChange)="to.set($event)" name="to">
      </div>
      <div>
        <label for="granularity">Granularity</label>
        <select id="granularity" [ngModel]="granularity()" (ngModelChange)="granularity.set($event)" name="granularity">
          <option value="30min">30 minutes</option>
          <option value="hour">Hour</option>
          <option value="day">Day</option>
        </select>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" [ngModel]="withWeather()" (ngModelChange)="withWeather.set($event)" id="weather" name="weather">
        <label for="weather">Show temperature</label>
      </div>
      <button class="btn" type="submit" [disabled]="loading()">Load</button>
    </form>
    @if (error()) {
      <p class="status negative">{{ error() }}</p>
    }
  </div>

  <!-- Summary cards and chart: always visible with conditional content -->
  <div class="chart-wrapper">
    @if (data() && data()!.consumption.length > 0) {
      <!-- Data available: show stats and chart -->
      <div class="grid two" style="margin-bottom: 1rem;">
        <div class="card">
          <div class="status">Total kWh</div>
          <div style="font-size:28px;font-weight:700;">{{ data()!.summary.totalKwh | number:'1.0-2' }}</div>
        </div>
        <div class="card">
          <div class="status">Average per day</div>
          <div style="font-size:28px;font-weight:700;">{{ data()!.summary.avgKwhPerDay | number:'1.0-2' }}</div>
        </div>
        <div class="card">
          <div class="status">Max day</div>
          <div style="font-size:28px;font-weight:700;">{{ data()!.summary.maxDayKwh | number:'1.0-2' }}</div>
          <div class="status">{{ data()!.summary.maxDay }}</div>
        </div>
      </div>

      <div class="card">
        <app-consumption-chart 
          [consumption]="data()!.consumption" 
          [weather]="withWeather() ? data()!.weather : undefined"
          [dateRangeStart]="from()"
          [dateRangeEnd]="to()">
        </app-consumption-chart>
      </div>
    } @else if (loading()) {
      <!-- Loading state -->
      <div class="card" style="padding: 3rem; text-align: center; color: #94a3b8;">
        <div style="display: inline-flex; align-items: center; gap: 0.75rem;">
          <div style="width: 24px; height: 24px; border: 3px solid #334155; border-top-color: #3ad1c5; border-radius: 50%; animation: spin 0.6s linear infinite;"></div>
          Loading consumption data...
        </div>
      </div>
    } @else {
      <!-- No data: show empty state with suggestion -->
      <div class="card" style="padding: 3rem; text-align: center;">
        <div style="color: #94a3b8; margin-bottom: 1rem;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“Š</div>
          <p><strong>No data available</strong></p>
          <p style="font-size: 0.875rem; margin-top: 0.5rem;">
            No consumption data found for the selected date range.
          </p>
        </div>
        <button class="btn" type="button" (click)="syncNow()" [disabled]="syncing()">
          Synchronize Now
        </button>
        <p style="font-size: 0.875rem; color: #64748b; margin-top: 1rem;">
          Sync your Linky meter to import consumption data
        </p>
      </div>
    }
  </div>
}

<div class="card">
  <h3>Profil utilisateur</h3>
  @if (profileMessage()) {
    <p class="status">{{ profileMessage() }}</p>
  }
  <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="grid two">
    <div>
      <label for="profileEmail">Email</label>
      <input id="profileEmail" type="text" [value]="profile()?.email" disabled>
    </div>
    <div>
      <label for="profileUsername">Username</label>
      <input id="profileUsername" type="text" formControlName="username" placeholder="Votre pseudo">
    </div>
    <button class="btn" type="submit" [disabled]="profileSaving()">Mettre Ã  jour</button>
  </form>

  <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="grid two" style="margin-top:12px;">
    <div>
      <label for="currentPassword">Mot de passe actuel</label>
      <input id="currentPassword" type="password" formControlName="currentPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
    </div>
    <div>
      <label for="newPassword">Nouveau mot de passe</label>
      <input id="newPassword" type="password" formControlName="newPassword" placeholder="Au moins 6 caractÃ¨res">
    </div>
    <button class="btn" type="submit" [disabled]="passwordSaving()">Changer le mot de passe</button>
  </form>
</div>
