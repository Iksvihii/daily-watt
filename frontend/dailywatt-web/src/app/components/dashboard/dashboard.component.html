<div style="max-width: 100%; margin: 0 auto;">
  <!-- Dashboard form card -->
  <div class="card dashboard-form">
    <div class="dashboard-header">
      <h3>Dashboard</h3>
      <button mat-raised-button color="primary" type="button" (click)="load()" [disabled]="loading()">{{ loading() ? 'Loading...' : 'Load' }}</button>
    </div>
    <form>
      <div class="form-row">
        @if (meters().length > 0) {
          <mat-form-field>
            <mat-label>Meter</mat-label>
            <mat-select [ngModel]="selectedMeterId()" (ngModelChange)="onMeterChange($event)" name="meter">
              @for (meter of meters(); track meter.id) {
                <mat-option [value]="meter.id">
                  {{ meter.label || meter.prm }}
                  @if (meter.isFavorite) { ‚≠ê }
                </mat-option>
              }
            </mat-select>
          </mat-form-field>
        }
        <mat-form-field>
          <mat-label>From</mat-label>
          <input matInput [matDatepicker]="fromPicker" [ngModel]="from()" (ngModelChange)="from.set(getDateTimeString($event))" name="from">
          <mat-datepicker-toggle matIconSuffix [for]="fromPicker"></mat-datepicker-toggle>
          <mat-datepicker #fromPicker></mat-datepicker>
        </mat-form-field>
        <mat-form-field>
          <mat-label>To</mat-label>
          <input matInput [matDatepicker]="toPicker" [ngModel]="to()" (ngModelChange)="to.set(getDateTimeString($event))" name="to">
          <mat-datepicker-toggle matIconSuffix [for]="toPicker"></mat-datepicker-toggle>
          <mat-datepicker #toPicker></mat-datepicker>
        </mat-form-field>
        <mat-form-field>
          <mat-label>Granularity</mat-label>
          <mat-select [ngModel]="granularity()" (ngModelChange)="granularity.set($event)" name="granularity">
            <mat-option value="day">Day</mat-option>
            <mat-option value="month">Month</mat-option>
            <mat-option value="year">Year</mat-option>
          </mat-select>
        </mat-form-field>
        <div class="form-group checkbox-group">
          <mat-checkbox 
            [ngModel]="withWeather()" 
            (ngModelChange)="withWeather.set($event)" 
            name="weather">
            Show temperature
          </mat-checkbox>
        </div>
      </div>
      <!-- Quick date shortcuts -->
      <div class="quick-select-wrapper">
        <span class="quick-select-label">Quick select:</span>
        <button mat-stroked-button type="button" (click)="setDateRange(7)" [class.active]="isRangeActive(7)">Last 7 days</button>
        <button mat-stroked-button type="button" (click)="setDateRange(30)" [class.active]="isRangeActive(30)">Last 30 days</button>
        <button mat-stroked-button type="button" (click)="setDateRange(90)" [class.active]="isRangeActive(90)">Last 90 days</button>
      </div>
    </form>
    @if (error()) {
      <p class="status negative">{{ error() }}</p>
    }
  </div>

  @if (true) {
    <!-- Summary cards and chart: always visible with conditional content -->
    <div class="chart-wrapper">
      @if (data() && data()!.consumption.length > 0) {
        <!-- Data available: show stats and chart -->
        <div class="summary-stats">
          <div class="stat">
            <div class="stat-label">Total kWh</div>
            <div class="stat-value">{{ data()!.summary.totalKwh | number:'1.0-2' }}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Avg/day</div>
            <div class="stat-value">{{ data()!.summary.avgKwhPerDay | number:'1.0-2' }}</div>
          </div>
          <div class="stat">
            <div class="stat-label">Max day</div>
            <div class="stat-value">{{ data()!.summary.maxDayKwh | number:'1.0-2' }}</div>
            <div class="stat-detail">{{ data()!.summary.maxDay }}</div>
          </div>
        </div>

        <app-consumption-chart 
          [consumption]="data()!.consumption"
          [granularity]="granularity()"
          [weather]="withWeather() ? data()!.weather : undefined">
        </app-consumption-chart>
      } @else if (loading()) {
        <!-- Loading state -->
        <div class="card" style="padding: 3rem; text-align: center; color: #94a3b8;">
          <div style="display: inline-flex; align-items: center; gap: 0.75rem; flex-direction: column;">
            <div style="width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #3ad1c5; border-radius: 50%; animation: spin 0.8s linear infinite;"></div>
            <div>Loading consumption data...</div>
          </div>
        </div>
      } @else {
        <!-- No data: show empty state with suggestion -->
        <div class="card" style="padding: 3rem; text-align: center;">
          <div style="color: #94a3b8; margin-bottom: 1rem;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">üìä</div>
            <p><strong>No data available</strong></p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem;">
              No consumption data found for the selected date range.
            </p>
          </div>
          <p style="font-size: 0.875rem; color: #64748b; margin-top: 1rem;">
            Tip: Import your consumption data from Excel in the Enedis settings.
          </p>
        </div>
      }
    </div>
  }
