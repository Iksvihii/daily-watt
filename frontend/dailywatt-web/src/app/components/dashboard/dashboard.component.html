<div class="card">
  <h3>Enedis status</h3>
  @if (statusMessage()) {
    <p class="status">{{ statusMessage() }}</p>
  }
  @if (!status() || !status()!.configured) {
    <p class="status">Enedis n'est pas configuré. Ajoutez vos identifiants et compteur pour synchroniser.</p>
    <a class="btn" routerLink="/enedis">Configurer Enedis</a>
  } @else {
    <div class="status">Compteur: {{ status()!.meterNumber }} • Maj: {{ status()!.updatedAt | date:'short' }}</div>
    <button class="btn" type="button" (click)="syncNow()" [disabled]="syncing()">Synchroniser maintenant</button>
  }
</div>

@if (status() && status()!.configured) {
  <div class="card">
    <h3>Dashboard</h3>
    <form class="grid two" (ngSubmit)="load()">
      <div>
        <label>From</label>
        <input type="datetime-local" [ngModel]="from()" (ngModelChange)="from.set($event)" name="from">
      </div>
      <div>
        <label>To</label>
        <input type="datetime-local" [ngModel]="to()" (ngModelChange)="to.set($event)" name="to">
      </div>
      <div>
        <label>Granularity</label>
        <select [ngModel]="granularity()" (ngModelChange)="granularity.set($event)" name="granularity">
          <option value="30min">30 minutes</option>
          <option value="hour">Hour</option>
          <option value="day">Day</option>
        </select>
      </div>
      <div style="display:flex;align-items:center;gap:8px;">
        <input type="checkbox" [ngModel]="withWeather()" (ngModelChange)="withWeather.set($event)" id="weather" name="weather">
        <label for="weather">Show temperature</label>
      </div>
      <button class="btn" type="submit" [disabled]="loading()">Load</button>
    </form>
    @if (error()) {
      <p class="status negative">{{ error() }}</p>
    }
  </div>

  @if (data()) {
    @if (data()!.consumption.length === 0) {
      <div class="card">
        <p class="status">Aucune donnée disponible. Lancez une synchronisation manuelle.</p>
        <button class="btn" type="button" (click)="syncNow()" [disabled]="syncing()">Synchroniser</button>
      </div>
    } @else {
      <div class="grid two">
        <div class="card">
          <div class="status">Total kWh</div>
          <div style="font-size:28px;font-weight:700;">{{ data()!.summary.totalKwh | number:'1.0-2' }}</div>
        </div>
        <div class="card">
          <div class="status">Average per day</div>
          <div style="font-size:28px;font-weight:700;">{{ data()!.summary.avgKwhPerDay | number:'1.0-2' }}</div>
        </div>
        <div class="card">
          <div class="status">Max day</div>
          <div style="font-size:28px;font-weight:700;">{{ data()!.summary.maxDayKwh | number:'1.0-2' }}</div>
          <div class="status">{{ data()!.summary.maxDay }}</div>
        </div>
      </div>

      <div class="chart-wrapper">
        <app-consumption-chart [consumption]="data()!.consumption" [weather]="withWeather() ? data()!.weather : undefined"></app-consumption-chart>
      </div>
    }
  }
}

<div class="card">
  <h3>Profil utilisateur</h3>
  @if (profileMessage()) {
    <p class="status">{{ profileMessage() }}</p>
  }
  <form [formGroup]="profileForm" (ngSubmit)="saveProfile()" class="grid two">
    <div>
      <label>Email</label>
      <input type="text" [value]="profile()?.email" disabled>
    </div>
    <div>
      <label>Username</label>
      <input type="text" formControlName="username" placeholder="Votre pseudo">
    </div>
    <button class="btn" type="submit" [disabled]="profileSaving()">Mettre à jour</button>
  </form>

  <form [formGroup]="passwordForm" (ngSubmit)="changePassword()" class="grid two" style="margin-top:12px;">
    <div>
      <label>Mot de passe actuel</label>
      <input type="password" formControlName="currentPassword" placeholder="••••••">
    </div>
    <div>
      <label>Nouveau mot de passe</label>
      <input type="password" formControlName="newPassword" placeholder="Au moins 6 caractères">
    </div>
    <button class="btn" type="submit" [disabled]="passwordSaving()">Changer le mot de passe</button>
  </form>
</div>
